# Functions, Stored Procedures, Triggers Exercises

Consider an _"user"_ table with _id, username, password, and last_login_ columns, _password_ must be crypted

1. Create a table _"user"_ with mentioned structure

```sql
CREATE TABLE IF NOT EXISTS "user" (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50),
    password TEXT,
    last_login TIMESTAMP
);

CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

2. Insert new user

```sql
INSERT INTO "user" (username, password)
	VALUES ('New User', crypt('123456', gen_salt('bf')));
```

2. Create a stored procedure to save date when a user tries to login

```sql
CREATE OR REPLACE PROCEDURE user_login (user_name VARCHAR, user_pwd VARCHAR) AS $$
DECLARE
    was_found BOOLEAN;

BEGIN
    SELECT COUNT(*) INTO was_found
    FROM "user"
        WHERE
            username = user_name
            AND
            password = crypt(user_pwd, password);

    IF (was_found = false) THEN
        RAISE EXCEPTION 'User not found';
    END IF;

    UPDATE "user"
    SET last_login = NOW()
    WHERE username = user_name;

    COMMIT;
END;
$$ LANGUAGE plpgsql;
```

3. Modify stored procedure to save in _"session_failed"_ when login fails

```sql
CREATE TABLE IF NOT EXISTS "session_failed" (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(50),
    last_time TIMESTAMP
);

CREATE OR REPLACE PROCEDURE user_login (user_name VARCHAR, user_pwd VARCHAR) AS $$
DECLARE
    was_found BOOLEAN;

BEGIN
    SELECT COUNT(*) INTO was_found
    FROM "user"
        WHERE
            username = user_name
            AND
            password = crypt(user_pwd, password);

    IF (was_found = false) THEN
    -- Here modifications
        INSERT INTO "session_failed" (username, last_time)
            VALUES(user_name, NOW());
        COMMIT;
    -- End of modifications

        RAISE EXCEPTION 'User not found';
    END IF;

    UPDATE "user"
    SET last_login = NOW()
    WHERE username = user_name;

    COMMIT;
END;
$$ LANGUAGE plpgsql;
```

4. Create a trigger to save in a new table _"user_update"_ when an user changes it username

```sql
CREATE TABLE IF NOT EXISTS "user_update" (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id INTEGER,
    prev_username TEXT,
    new_username TEXT,
    at TIMESTAMP,
    CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES "user"(id)
);

CREATE OR REPLACE FUNCTION save_update_log()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO "user_update" (user_id, prev_username, new_username, at)
        VALUES (NEW.id, OLD.username, NEW.username, NOW());

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE TRIGGER save_update_user AFTER UPDATE ON "user"
FOR EACH ROW
WHEN (OLD.username IS DISTINCT FROM NEW.username)
EXECUTE FUNCTION save_update_log();
```

5. Execute next queries, and, show tables every time

- Do incorrect login
- Insert New User
- Do correct login
- Do incorrect login
- Update user

```sql
-- 1. DO INCORRECT LOGIN
CALL user_login('New User', '123456');

SELECT * FROM "user";
SELECT * FROM session_failed;
SELECT * FROM user_update;

-- user
id|username|password|last_login|
--+--------+--------+----------+

-- session_failed
id|username|last_time              |
--+--------+-----------------------+
 1|New User|2024-03-18 22:33:11.100|

-- user_update
id|user_id|prev_username|new_username|at|
--+-------+-------------+------------+--+

-- 2. INSERT NEW USER
INSERT INTO "user" (username, password)
	VALUES ('New User', crypt('123456', gen_salt('bf')));

SELECT * FROM "user";
SELECT * FROM session_failed;
SELECT * FROM user_update;

-- user (As Record)
Name      |Value                                                       |
----------+------------------------------------------------------------+
id        |1                                                           |
username  |New User                                                    |
password  |$2a$06$PDKM2xWKXspJqarHG/0/IOuOLd15Jex3HBflTrWcubI5BWsTv70Xi|
last_login|                                                            |

-- session_failed
id|username|last_time              |
--+--------+-----------------------+
 1|New User|2024-03-18 22:33:11.100|

 -- user_updates
id|user_id|prev_username|new_username|at|
--+-------+-------------+------------+--+

-- 3. DO CORRECT LOGIN
CALL user_login('New User', '123456');

SELECT * FROM "user";
SELECT * FROM session_failed;
SELECT * FROM user_update;

-- user (As Record)
Name      |Value                                                       |
----------+------------------------------------------------------------+
id        |1                                                           |
username  |New User                                                    |
password  |$2a$06$PDKM2xWKXspJqarHG/0/IOuOLd15Jex3HBflTrWcubI5BWsTv70Xi|
last_login|2024-03-18 22:40:12.796                                     |

-- session_failed
id|username|last_time              |
--+--------+-----------------------+
 1|New User|2024-03-18 22:33:11.100|

-- user_update
id|user_id|prev_username|new_username|at|
--+-------+-------------+------------+--+

-- 4. DO INCORRECT LOGIN
CALL user_login('New User', '1234567');

SELECT * FROM "user";
SELECT * FROM session_failed;
SELECT * FROM user_update;

-- user (As Record)
Name      |Value                                                       |
----------+------------------------------------------------------------+
id        |1                                                           |
username  |New User                                                    |
password  |$2a$06$PDKM2xWKXspJqarHG/0/IOuOLd15Jex3HBflTrWcubI5BWsTv70Xi|
last_login|2024-03-18 22:40:12.796                                     |

-- session_failed
id|username|last_time              |
--+--------+-----------------------+
 1|New User|2024-03-18 22:33:11.100|
 2|New User|2024-03-18 22:42:04.259|

-- user_update
id|user_id|prev_username|new_username|at|
--+-------+-------------+------------+--+

-- 5. UPDATE USER
UPDATE "user"
SET username = 'New User Name'
WHERE username = 'New User';

SELECT * FROM "user";
SELECT * FROM session_failed;
SELECT * FROM user_update;

-- user (As Record)
Name      |Value                                                       |
----------+------------------------------------------------------------+
id        |1                                                           |
username  |New User Name                                               |
password  |$2a$06$PDKM2xWKXspJqarHG/0/IOuOLd15Jex3HBflTrWcubI5BWsTv70Xi|
last_login|2024-03-18 22:40:12.796                                     |

-- session_failed
id|username|last_time              |
--+--------+-----------------------+
 1|New User|2024-03-18 22:33:11.100|
 2|New User|2024-03-18 22:42:04.259|

-- user_update
id|user_id|prev_username|new_username |at                     |
--+-------+-------------+-------------+-----------------------+
 1|      1|New User     |New User Name|2024-03-18 22:48:48.915|
```
